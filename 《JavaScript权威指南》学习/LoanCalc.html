<!DOCTYPE html>
<html>
  <head>
    <title>Loan Calculator</title>
    <style>
      .output {
        font-weight: bold;
      }
      #payment {
        text-decoration: underline;
      }
      #graph {
        border: 1px solid black;
      }
      th, td {
        vertical-align: top;
      }
    </style>
  </head>
  <body>
    <table>
      <tr>
        <th>Enter Loan Data:</th>
        <td></td>
        <th>Loan Balance, Cumulative Equity, and Interest Payments</th>
      </tr>
      <tr>
        <td>amount of the loan($):</td>
        <td><input id='amount' onchange="calculate();"></td>
        <td rowspan=8>
          <canvas id='graph' width='400' height='250'></canvas>
        </td>
      </tr>
      <tr>
        <td>Annual interest(%):</td>
        <td><input id='apr' onchange='calculate()'></td>
      </tr>
      <tr>
        <td>Repayment period(years):</td>
        <td><input id='years' onchange='calculate()'></td>
      </tr>
      <tr>
        <td>Zipcode(to find lenders):</td>
        <td><input id='zipcode' onchange='calculate()'></td>
      </tr>
      <tr>
        <th>Approximate Payments</th>
        <td><button onclick="calculate()">calculate</button></td>
      </tr>
      <tr>
        <td>Monthly payment:</td>
        <td>$<span id='payment' class="output"></span></td>
      </tr>
      <tr>
        <td>Total payment:</td>
        <td>$<span id='total' class="output"></span></td>
      </tr>
      <tr>
        <td>Total interest:</td>
        <td>$<span id='totalInterest' class="output"></span></td>
      </tr>
      <tr>
        <th>Sponsors:</th>
        <td colspan=2>
          Apply for your loan with one of these fine lenders:
          <div id='lenders'></div>
        </td>
      </tr>
    </table>
    <script>
      "use strict"
      function calculate() {
        var amount = document.getElementById('amount');
        var apr = document.getElementById('apr');
        var years = document.getElementById('years');
        var zipcode = document.getElementById('zipcode');
        var payment = document.getElementById('payment');
        var total = document.getElementById('total');
        var totalInterest = document.getElementById('totalInterest');

        var principal = parseFloat(amount.value);
        // å°†ç™¾åˆ†æ¯”æ ¼å¼è½¬åŒ–ä¸ºå°æ•°æ ¼å¼ï¼Œå¹¶ä»å¹´åˆ©ç‡è½¬åŒ–ä¸ºæœˆåˆ©ç‡
        var interest = parseFloat(apr.value) / 100 / 12;
        // å°†å¹´åº¦èµ”ä»˜è½¬æ¢ä¸ºæœˆåº¦èµ”ä»˜
        var payments = parseFloat(years.value) * 12;

        // è®¡ç®—æœˆåº¦èµ”ä»˜çš„æ•°æ®
        var x = Math.pow(1 + interest, payments);  // math.pow() è¿›è¡Œå¹‚æ¬¡è¿ç®—
        var monthly = (principal * x * interest) / (x - 1);

        if(isFinite(monthly)) {
          payment.innerHTML = monthly.toFixed(2);
          total.innerHTML = (monthly * payments).toFixed(2);
          totalInterest.innerHTML = ((monthly * payments) - principal).toFixed(2);

          // ä¿å­˜æ•°æ®
          save(amount.value, apr.value, years.value, zipcode.value);

          try {
            getLenders(amount.value, apr.value, years.value, zipcode.value);
          } catch (error) {
            
          }

          // æœ€åï¼Œç”¨å›¾è¡¨å±•ç¤ºè´·æ¬¾ä½™é¢ã€åˆ©æ¯å’Œèµ„äº§æ”¶ç›Š
          chart(principal, interest, monthly, payments);
        } else {
          payment.innerHTML = '';
          totalInterest.innerHTML = '';
          totalInterest.innerHTML = '';
          chart();
        }
      }
      function save(amount, apr, years, zipcode) {
        if(window.localStorage) {
          localStorage.loan_amount = amount;
          localStorage.loan_apr = apr;
          localStorage.loan_years = years;
          localStorage.loan_zipcode = zipcode;
        }
      }

      // åœ¨æ–‡æ¡£é¦–æ¬¡åŠ è½½æ—¶ï¼Œå°†ä¼šå°è¯•è¿˜åŸä¸Šæ¬¡è¾“å…¥çš„å­—æ®µ
      window.onload = function() {
        if(window.localStorage && localStorage.loan_amount) {
          document.getElementById('amount').value = localStorage.loan_amount;
          document.getElementById('apr').value = localStorage.loan_apr;
          document.getElementById('years').value = localStorage.loan_years;
          document.getElementById('zipcode').value = localStorage.loan_zipcode;
        }
      }

      // ç”¨æˆ·è¾“å…¥å‘é€åˆ°æœåŠ¡å™¨ç«¯
      // å°†è¿”å›ä¸€ä¸ªæœ¬åœ°æ”¾è´·äººçš„é“¾æ¥åˆ—è¡¨ï¼ˆğŸŒ°ä¸­å›½ä¸­å¹¶æ²¡æœ‰å®ç°è¯¥æœåŠ¡ï¼‰
      // ä½†å¦‚æœæœåŠ¡å­˜åœ¨ï¼Œè¯¥å‡½æ•°ä¼šä½¿ç”¨å®ƒ
      function getLenders(amount, apr, years, zipcode) {
        if (!window.XMLHttpRequest) return;

        // æ‰¾åˆ°è¦æ˜¾ç¤ºæ”¾è´·äººåˆ—è¡¨çš„å…ƒç´ 
        var ad = document.getElementById('lenders');
        if(!ad) return

        var url = 'getLenders.php' +
        "?amt=" + encodeURIComponent(amount) +
        "&apr=" + encodeURIComponent(apr) +
        "&yrs=" + encodeURIComponent(years) +
        "&zip=" + encodeURIComponent(zipcode);

        // é€šè¿‡XMLHttpRequestå¯¹è±¡æ¥æå–è¿”å›çš„æ•°æ®
        var req = new XMLHttpRequest();
        req.open('GET', url);
        res.send(null);  // ä¸å¸¦ä»»ä½•æ­£æ–‡å‘é€è¿™ä¸ªè¯·æ±‚

        // åœ¨è¿”å›æ•°æ®ä¹‹å‰ï¼Œæ³¨å†Œä¸€ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°ï¼Œè¿™ä¸ªå¤„ç†å‡½æ•°
        // å°†ä¼šåœ¨æœåŠ¡å™¨çš„å“åº”è¿”å›åˆ°å®¢æˆ·ç«¯çš„æ—¶å€™è°ƒç”¨
        req.onreadystatechange = function() {
          if(req.readyState == 4 && req.status == 200) {
            // å¦‚æœä»£ç è¿è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜å¾—åˆ°äº†ä¸€ä¸ªåˆæ³•ä¸”å®Œæ•´çš„HTTPå“åº”
            var response = req.responseText;  // HTTPå“åº”æ˜¯ä»¥å­—ç¬¦ä¸²çš„å½¢å¼å‘ˆç°çš„
            
            var lenders = JSON.parse(response)

            // å°†ä¸Šæ–¹çš„è§£æå†…å®¹è½¬æ¢ä¸ºHTMLå­—ç¬¦ä¸²å½¢å¼
            var list = ''
            for (var i = 0; i < lenders.length; i++) {
              list += "<li><a href='" + lenders[i].url + "'>" + lenders[i].name + "</a></li>";
            }
            ad.innerHTML = "<ul>" + list + "</ul>"
          }
        }
      }

      // åœ¨HTML <canvas> å…ƒç´ ä¸­ç”¨å›¾è¡¨å±•ç¤ºæœˆåº¦è´·æ¬¾ä½™é¢ã€åˆ©æ¯å’Œèµ„äº§æ”¶ç›Š
      function chart(principal, interest, monthly, payments) {
        var graph = document.getElementById('graph');
        graph.width = graph.width;  // æ¸…é™¤å¹¶é‡ç½®ç”»å¸ƒ

        if(arguments.length == 0 || !graph.getContext) return;

        // è·å¾—ç”»å¸ƒå…ƒç´ çš„â€œcontextâ€å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å®šä¹‰äº†ä¸€ç»„ç»˜ç”»API
        var g = graph.getContext('2d');  // æ‰€æœ‰ç»˜ç”»æ“ä½œéƒ½å°†åŸºäºè¿™ä¸ªå¯¹è±¡
        var width = graph.width, height = graph.height;

        // å°†ä»˜æ¬¾æ•°å­—å’Œç¾å…ƒæ•°æ®è½¬æ¢ä¸ºåƒç´ 
        function paymentToX(n) {
          return n * width / payments;
        }
        function amountToY(a) {
          return height - (a * height / (monthly * payments * 1.05));
        }

        // ä»˜æ¬¾æ•°æ®æ˜¯ä»(0, 0)åˆ°(payments, monthlu * payments)çš„ç›´çº¿
        g.moveTo(paymentToX(0), amountToY(0));  // ä»å·¦ä¸‹æ–¹å¼€å§‹
        g.lineTo(paymentToX(payments), amountToY(monthly * payments));  // ç»˜åˆ¶åˆ°å³ä¸Šæ–¹
        g.lineTo(paymentToX(payments), amountToY(0));  // å†ç»˜åˆ¶åˆ°å³ä¸‹æ–¹
        g.closePath();  // å°†ç»“å°¾è¿æ¥å¼€å¤´
        g.fillStyle = '#f88';
        g.fill();  // å¡«å……çŸ©å½¢
        g.font = '12px bold sans-serif';
        g.fillText('Total Interest Payments', 20, 20)

        // å¾ˆå¤šèµ„äº§ä¸æ˜¯çº¿æ€§çš„ï¼Œå¾ˆéš¾åæ˜ åˆ°ğŸ“ˆä¸­
        var equity = 0;
        g.beginPath();  // å¼€å§‹ç»˜åˆ¶å›¾å½¢
        g.moveTo(paymentToX(0), amountToY(0))
        for (var p = 1; p <= payments; p++) {
          // è®¡ç®—å‡ºæ¯ä¸€ç¬”èµ”ä»˜çš„åˆ©æ¯
          var thisMonthsInterest = (principal - equity) * interest;
          equity += (monthly - thisMonthsInterest);  // å¾—åˆ°èµ„äº§é¢
          g.lineTo(paymentToX(p), amountToY(equity));
        }
        g.lineTo(paymentToX(payments), amountToY(0));  // å°†æ•°æ®ç»˜åˆ¶åˆ°xè½´
        g.closePath();
        g.fillStyle = 'green';
        g.fill();  // å¡«å……çŸ©å½¢
        g.font = '12px bold sans-serif';
        g.fillText('Total Equity', 20, 35)

        // å†æ¬¡å¾ªç¯ï¼Œä½™é¢æ˜¾ç¤ºä¸ºé»‘è‰²çš„ç²—çº¿æ¡
        var bal = principal;
        g.beginPath();
        g.moveTo(paymentToX(0), amountToY(bal));
        for (var p = 1; p <= payments; p++) {
          var thisMonthsInterest = bal * interest;
          bal -= (monthly - thisMonthsInterest);  // å¾—åˆ°èµ„äº§é¢
          g.lineTo(paymentToX(p), amountToY(bal));
        }
        g.lineWidth = 3;
        g.stroke()  // ç»˜åˆ¶ä½™é¢çš„æ›²çº¿
        g.fillStyle = 'black';
        g.fillText('Loan Balance', 20, 50);

        // å°†å¹´åº¦æ•°æ®åœ¨xè½´åšæ ‡è®°
        g.textAlign = 'center';
        var y = amountToY(0);
        for (var year = 1; year * 12 <= payments; year++) {
          var x = paymentToX(year * 12);
          g.fillRect(x - 0.5, y - 3, 1, 3);
          if (year == 1) g.fillText("Year", x, y - 5);
          if (year % 5 == 0 && year * 12 != payments) g.fillText(String(year), x, y - 5);
        }

        // å°†èµ”ä»˜æ•°é¢æ ‡è®°åœ¨å³è¾¹ç•Œ
        g.textAlign = 'right';
        g.textBaseline = 'middle';
        var ticks = [monthly * payments, principal];
        var rightEdge = paymentToX(payments);
        for (var i = 0; i < ticks.length; i++) {
          var y = amountToY(ticks[i]);
          g.fillRect(rightEdge - 3, y - 0.5, 3, 1);
          g.fillText(String(ticks[i].toFixed(0)), rightEdge - 5, y);
        }

      }
    </script>
  </body>
</html>